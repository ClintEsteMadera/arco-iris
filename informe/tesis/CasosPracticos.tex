\section{Casos Prácticos}
\label{sec:casosPracticos}

	En este capítulo se presentan y analizan algunos casos de prueba concretos de uso de Arco Iris, a fin de evaluar su
	comportamiento. Para dicho fin, se reutilizará la simulación presentada en Znn. \todo{linkear a donde explicamos la
	simulacion!}

	El sistema consiste en un sitio de noticias y la simulación nos permite manejar variables tales como la cantidad de
	servidores y la fidelidad de la información que se provee, es decir, permite eliminar determinado tipo de contenido
	(e.g: videos) para mejorar el tiempo de respuesta experimentado por el usuario del sitio. Estas y otras variables
	permiten, mediante la auto reparación, alterar el comportamiento del sistema para poder seguir brindando un servicio
	óptimo según los requerimientos de auto reparación especificados mediante escenarios de atributos de calidad.

	\subsection{Arquitectura del Sistema}
		Los componentes principales de la arquitectura de Znn son clientes y servidores. Éstos no se conectan directamente
		entre sí, sino que lo hacen por medio de un proxy, al cual llegan todas las peticiones de los clientes, y es él quien
		conoce todos los servidores disponibles y distribuye el trabajo entre ellos. A continuación se muestra un diagrama
		de la arquitectura del sistema, extraída utilizando la herramienta AcmeStudio:

		\todo{eliminar warnings de la arquitectura en AcmeStudio y agregar la imagen de la misma aqui}

		En el apéndice \ref{sec:arquitecturaZNN} se puede observar el código fuente de la arquitectura de Znn.

		Existen tres \emph{concerns} en la arquitectura. A fin de simplificar las pruebas para el lector, se utilizarán sólo
		dos, a saber:
		\begin{itemize}
			\item Tiempo de Respuesta: tiempo de respuesta promedio experimentado por el usuario de Znn, y
			\item Costo: refleja la cantidad de servidores prestando servicio con los que cuenta Znn en un determinado momento.
		\end{itemize}

		Para las pruebas realizadas en este trabajo, sólo se utilizarán las siguientes tácticas, con el fin de modificar el
		comportamiento del sistema en ejecución:
		\begin{itemize}
			\item Dar de alta un servidor
			\item Dar de baja un servidor
		\end{itemize}

		Para que estas tácticas puedan ejecutarse, Znn implementa los correspondientes \emph{effectors}, quienes serán
		los responsables de efectuar los cambios propiamente dichos sobre el sistema en \emph{runtime}. Los \emph{effectors}
		serán invocados desde las tácticas, cuyas implementaciones en Znn pueden verse en el apéndice \ref{sec:tacticasZNN}.
	
		Antes de comenzar, cabe aclarar que, salvo que se indique lo contrario, la configuración de pesos para cada uno de los
		\emph{concerns} del sistema será equidistribuida. Esta decisión convierte a las prioridades entre escenarios en el único
		factor influyente en la selección de una estrategia candidata para reparar el sistema (ver algoritmo de selección de
		estrategias en la sección \ref{sec:arcoIrisStrategyScoring}), simplificando así los cálculos, así como   también la
		comprensibilidad de los resultados presentados.
	\subsection{Comportamiento del Sistema sin Auto Reparación}
		
		Para comenzar, se presenta el comportamiento del sistema de no existir escenarios ni estrategias, esto permitirá
		evaluar la variación de comportamiento a medida que se vayan agregando escenarios y/o estrategias.

		En las figuras \ref{fig:testcase1_1_expRespTime} y \ref{fig:testcase1_1_cost} se puede observar el comportamiento del
		sistema sin escenarios, es decir, sin auto reparación.
		\begin{figure}[H]
			\centering
				\includegraphics[width=1.00\textwidth]{images/testcase1_1_expRespTime.png}
			\caption{Comportamiento del sistema sin escenarios: tiempo de respuesta}
			\label{fig:testcase1_1_expRespTime}
		\end{figure}

		\begin{figure}[H]
			\centering
				\includegraphics[width=1.00\textwidth]{images/testcase1_1_cost.png}
			\caption{Comportamiento del sistema sin escenarios: costo de levantar un servidor}
			\label{fig:testcase1_1_cost}
		\end{figure}

		Como se puede observar, la simulación ha sido configurada explícitamente para que Znn se comporte de la siguiente
		manera: el tiempo de respuesta crece hasta superar los 600 ms., man\-te\-nién\-do\-se allí hasta los 30 segundos, para
		luego ir bajando paulatinamente hasta estacionarse cerca de los 400 ms. Notar que el costo de los servidores se mantiene
		inmutable frente a los cambios en el tiempo de respuesta, es decir que el sistema trabaja siempre con un único servidor.
		Es importante tener en cuenta que la merma en el tiempo de respuesta no se debe a ninguna acción propia de la auto
		reparación, sino a cambios en el ambiente, externos al sistema, como por ejemplo el ancho de banda de la conexión de		cada uno de sus clientes.
	\subsection{Comportamiento del Sistema con un Único Escenario}

		Habiendo presentado el comportamiento del sistema sin escenarios definidos, se procederá definir el primer escenario, el
		cual consiste en determinar un umbral máximo aceptado de 600 ms. para el tiempo de respuesta experimentado por el
		usuario. Tener en cuenta que aún no se ha definido ninguna estrategia, por lo cual Arco Iris detectará que existe un
		escenario que no se satisface pero no encontrará ninguna estrategia capaz de repararlo. En la figura  
		\ref{fig:scenario_expRespTime} se muestra el detalle del escenario creado.		\todo{Refrescar todos los screenshots de la GUI (al final!)}

		\begin{figure}[ht]
			\centering
				\includegraphics[width=0.75\textwidth]{images/scenario_expRespTime.png}
			\caption{Detalle del único escenario del sistema}
			\label{fig:scenario_expRespTime}
		\end{figure}

		En el apéndice \ref{sec:scenarioExpRespTimeXML} podemos ver la representación de este escenario en XML.
		
		\todo{TURCO Y JONY: Continuar revisando desde aca}

		Al no existir ninguna estrategia, el costo de servidores no se verá modificado, por lo cual el gráfico en la
		figura \ref{fig:testcase1_1_expRespTime_threshold} será el mismo que el del caso anterior, salvo que permite observar
		en qué momento se supera el umbral determinado para el tiempo de respuesta.

		\begin{figure}[ht]
			\centering
				\includegraphics[width=1.00\textwidth]{images/testcase1_1_expRespTime_threshold.png}
			\caption{Umbral para el tiempo de respuesta superado}
			\label{fig:testcase1_1_expRespTime_threshold}
		\end{figure}

		\todo{Mostramos el log? lo ponemos en el Apendice???}

	\subsection{Comportamiento del Sistema con un único Escenario y una única Estrategia}
		El próximo paso será definir una estrategia que pueda actuar cuando el escenario planteado deje de cumplirse. La misma
		consistirá simplemente en agregar un servidor, siempre y cuando existan servidores disponibles. La estrategia,
		definida en Stitch, será la siguiente:

		\begin{Verbatim}[gobble=3]
			strategy EnlistServerResponseTime {
			  t0: (true) -> enlistServers(1) @[5000 /*ms*/] {
			    t1: (!RESP_TIME_STILL_BROKEN) -> done;
			    t2: (default) -> TNULL;
			  }
			}
		\end{Verbatim}

		Al agregar esta estrategia, observamos en la figura \ref{fig:testcase1_2_expRespTime} que el tiempo de respuesta
		experimentado por el usuario se corrige casi instantáneamente.

		\begin{figure}[ht]
			\centering
				\includegraphics[width=1.00\textwidth]{images/testcase1_2_expRespTime.png}
			\caption{Mejora del tiempo de respuesta debido a la aplicación de una estrategia}
			\label{fig:testcase1_2_expRespTime}
		\end{figure}

		Desde ya que este comportamiento se debe a la aplicación de la estrategia, el gráfico de la figura
		\ref{fig:testcase1_2_cost} nos muestra cómo varía el costo de servidores al aplicarse la estrategia, simultáneamente
		con la mejora del tiempo de respuesta.

		\begin{figure}[ht]
			\centering
				\includegraphics[width=1.00\textwidth]{images/testcase1_2_cost.png}
			\caption{Variación del costo de servidores debido a la aplicación de la estrategia}
			\label{fig:testcase1_2_cost}
		\end{figure}

		En resumen, lo que hemos visto hasta aquí consiste en:
		\begin{enumerate}
			\item Comportamiento del sistema sin ninguna información de auto reparación.
			\item Comportamiento del sistema con un escenario definido pero sin estrategias que lo puedan reparar.
			\item Comportamiento del sistema con un escenario definido y con una estrategia que lo repara.
		\end{enumerate}

	\subsection{\emph{Tradeoff} entre Estrategias}
	
		\todo{Implementar el caso de 1 escenario con dos estrategias compitiendo entre si (el codigo ya esta hecho)}

	\subsection{\emph{Tradeoff} entre Escenarios}
		Ahora bien, si analizamos el comportamiento del tiempo de respuesta, vemos que a partir de un determinado momento las
		condiciones del sistema cambian, lo cual hace que el tiempo de respuesta baje sin que la auto reparación tenga
		incidencia alguna en este comportamiento.

		Esto hace que el escenario de tiempo de respuesta se siga cumpliendo, pero observemos que el sistema sigue funcionando
		con dos servidores, cuando en realidad es altamente probable que pueda cumplir con las necesidades de
		eficiencia con uno solo. Entonces, ¿por qué no minimizar el costo de los servidores? Pues lograremos esto
		definiendo otro escenario cuya restricción consistirá en definir que no exista más de un servidor funcionando
		simultáneamente.

		En la figura \ref{fig:scenario_cost} podemos observar el escenario que crearemos.
		\begin{figure}[H]
			\centering
				\includegraphics[width=0.80\textwidth]{images/scenario_cost.png}
			\caption{Detalle de un escenario de costo de servidores}
			\label{fig:scenario_cost}
		\end{figure}

		En el apéndice \ref{sec:scenarioCostXML} podemos ver la representación de este escenario en XML.

		Relacionado a este escenario, agregaremos la siguiente estrategia que podrá ser utilizada en caso de Arco Iris
		considere necesario repararlo:

		\begin{Verbatim}[gobble=3]
			strategy ReduceOverallCost {
			  t0: (true) -> dischargeServers(1) @[2000 /*ms*/] {
			    t1: (!COST_STILL_BROKEN) -> done;
			    t3: (default) -> TNULL;
			  }
			}
		\end{Verbatim}

		Recordemos que el escenario de tiempo de respuesta es el primero que deja de cumplirse, y que para que sea corregido
		debe levantarse un servidor, pero esto es justamente lo que acabamos de definir en el nuevo escenario que no debería
		ocurrir. ¿Cómo repararemos el tiempo de respuesta entonces? Aquí es donde entran en juego las prioridades de los
		escenarios: nuestro escenario prioritario será el del tiempo de respuesta, por lo cual este podrá repararse en
		detrimento del escenario del costo de servidores.

		Una vez reparado el tiempo de respuesta, el escenario de costo dejará de cumplirse y la auto reparación no intentará
		repararlo mientras que la utilidad del sistema en el estado actual sea mayor a la prevista en caso de repararlo. Esto
		hará que recién se repare el escenario de costo cuando esta reparación no rompa el escenario de tiempo de respuesta.

		Como podemos observar en el gráfico presentado a continuación, efectivamente era factible bajar un servidor sin que se
		dejara de satisfacer el escenario de tiempo de respuesta, llegando así al estado ideal en que ambos escenarios se
		satisfacen simultáneamente. Si bien el tiempo de respuesta sufre un pequeño detrimento al trabajar el sistema con un
		servidor menos, los valores obtenidos siguen siendo suficientemente buenos debido a los cambios que se han suscitado
		en el entorno en que funciona el sistema, sin ninguna intervención de la auto reparación. En resumen, al configurar
		los escenarios más prioritarios permitimos a Arco Iris tomar la decisión de qué escenario reparar en cada instante y
		con qué estrategia. En la figura \ref{fig:testcase1_3_expRespTime} podemos observar un ejemplo concreto de la potencia
		de definir prioridades entre escenarios.

		\begin{figure}[H]
			\centering
				\includegraphics[width=1.00\textwidth]{images/testcase1_3_expRespTime.png}
			\caption{Uso de prioridades favoreciendo al escenario de eficiencia sobre el de costo}
			\label{fig:testcase1_3_expRespTime}
		\end{figure}

		En la figura \ref{fig:testcase1_3_cost} podemos observar cómo el sistema desactiva un servidor en el preciso momento
		en que el entorno de la aplicación cambia y el tiempo de respuesta mejora por razones ajenas a la auto reparación,
		aprovechando esto, Arco Iris logra satisfacer así un escenario que estaba sin cumplirse, sin perjudicar a ninguno de
		los escenarios que se estaban cunmpliendo hasta ese momento.

		\begin{figure}[H]
			\centering
				\includegraphics[width=1.00\textwidth]{images/testcase1_3_cost.png}
			\caption{Reducción del costo como consecuencia de un cambio en el entorno}
			\label{fig:testcase1_3_cost}
		\end{figure}
		
		Esto nos muestra cómo pueden convivir varios escenarios, y cómo Arco Iris sabrá detectar cual será la estrategia que
		le permitirá maximizar la utilidad del sistema gracias a la configuración de escenarios y sus respectivas prioridades.

	\subsection{\emph{Tradeoff} entre \emph{Concerns}}

		\todo{Implementar el caso en que las prioridades son iguales y el algoritmo decide por peso del concern de un
		escenario en particular}
